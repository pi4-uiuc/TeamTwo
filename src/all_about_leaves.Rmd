---
title: "All About Leaves"
output: html_notebook
---

Let's load up the 67 leaf-related variables we're going to explore:

```{r}
library(traits)
library(dplyr)
library(reshape2)

options(#betydb_key = readLines('~/.betykey', warn = FALSE),
  betydb_url = "https://betydb.org",
  betydb_api_version = 'beta')

leaf_variables <- betydb_query(table = "variables", limit = 'none') %>%    # Should take about 15 seconds
  mutate(variable_id = id) %>%    # We're going to need to be joining based on variable_id later
  select(variable_id, description, name, units) %>%    # Only care about the important stuff
  filter(grepl("leaf",name)) %>%    # Only those variables with "leaf" in the name
  collect()

```

And a sufficiently large table of measurements of said variables:

```{r}

leaf_traits_bare <- betydb_query(table = "traits", limit = 'none') %>%    # Should take about 70 seconds
  inner_join(leaf_variables, by = "variable_id") %>%
  select(name, mean, units, description, date, specie_id, site_id, treatment_id)

```

Let's hook leaf_traits up to the species table:

```{r}

species <- betydb_query(table = "species", limit = 'none') %>%    ## I believe there are 70529 distinct species total; this takes around 10 minutes
  mutate(specie_id = id)

leaf_traits <- leaf_traits_bare %>%
  left_join(species, by = "specie_id") %>%
  filter(!is.na(scientificname)) %>%    # For some reason there are a lot of specie_id values not found in the species table...
  select(name, mean, units, description, date, specie_id, scientificname, commonname, site_id, treatment_id)

```

Now we're cooking with gas. Some of the species and variables are rather obscure, though (in fact only 21 of the 67 leaf-related variables are populated at all, by my count), so let's see which species have had the most unique variables measured, and which variables have been measured across the widest range of species:

```{r}

traits_ranking <- leaf_traits %>%
  group_by(name) %>%
  mutate(species_with_trait = length(unique(scientificname))) %>%
  select(name, species_with_trait) %>%
  unique

species_ranking <- leaf_traits %>%
  group_by(scientificname) %>%
  mutate(traits_of_species = length(unique(name))) %>%
  select(scientificname, commonname, traits_of_species) %>%
  unique

```

It appears there are only 9 leaf variables that have been measured across 10+ species, and only 48 species have had 3+ unique leaf variables measured. Concerning ourselves only with these important species and variables, why not build a support vector machine that can predict which species a plant is, given one or more measurements of its leaves?

```{r}

important_species <- species_ranking %>%
  filter(traits_of_species >= 3) %>%
  select(scientificname) %>%
  collect()

important_traits <- traits_ranking %>%
  filter(species_with_trait >= 10) %>%
  select(name) %>%
  collect()

important_species = as.vector(important_species$scientificname)
important_traits = as.vector(important_traits$name)

important_leaf_traits <- leaf_traits %>%
  filter((name %in% important_traits) & (scientificname %in% important_species)) %>%
  select(scientificname, name, mean) %>%
  group_by(scientificname, name) %>%
  mutate(supermean = mean(mean)) %>%
  select(scientificname, name, supermean) %>%
  unique

organized_important_leaf_traits <- dcast(important_leaf_traits, scientificname ~ name, value.var="supermean")

predict_species <- function(c2n_leaf = NA, leaf_biomass_area = NA, leafN = NA, leafP = NA, leaf_respiration_rate_m2 = NA, leaf_longevity = NA, leafC = NA, leaf_biomass_plant = NA, leaf_turnover_rate = NA) {
  prediction_key = c(c2n_leaf, leaf_biomass_area, leaf_biomass_plant, leaf_longevity, leaf_respiration_rate_m2, leaf_turnover_rate, leafC, leafN, leafP)
  n = nrow(organized_important_leaf_traits)
  m = ncol(organized_important_leaf_traits)
  distance_column = data.frame(matrix(ncol = 1, nrow = n))
  for(i in 1:nrow(organized_important_leaf_traits)){
    distance_column[i,1] = species_distance(organized_important_leaf_traits[i,2:m], prediction_key)
  }
  results_table = organized_important_leaf_traits %>%
    cbind(distance_column)
  results_table = results_table[,c(1,m+1)]
  colnames(results_table) <- c("Species","Difference")
  print(nrow(results_table))
  print(length(results_table$Difference))
  return(arrange(results_table, results_table[,2])[1:3,])
}


species_distance <- function(species_data, data_point) {
  incomparables = 0
  n = length(species_data)
  sum_distance = 0
  for(i in 1:length(species_data)){
    if(!is.na(species_data[i]) & !is.na(data_point[i])){
      sum_distance = sum_distance + ((species_data[i]-data_point[i])/data_point[i])^2 + ((species_data[i]-data_point[i])/species_data[i])^2
    }
    else {
      incomparables = incomparables + 1
    }
  }
  if(incomparables == n){
    return(NA)
  }
  else {
    return(sum_distance / (n - incomparables))
  }
}

results <- predict_species(leaf_biomass_area = 1000, leafP = 0.1, leaf_turnover_rate = 0.4)


```
