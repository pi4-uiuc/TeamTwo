---
title: "All About Leaves"
output: html_notebook
---

Let's load up the 67 leaf-related variables we're going to explore:

```{r}
library(readr)
library(dplyr)
library(reshape2)

options(#betydb_key = readLines('~/.betykey', warn = FALSE),
  betydb_url = "https://betydb.org",
  betydb_api_version = 'beta')

leaf_variables <- readRDS("~/TeamTwo/data/variables.rds") %>%
  select(variable_id, description, name, units) %>%    # Only care about the important stuff
  collect()

```

And a sufficiently large table of measurements of said variables:

```{r}

leaf_traits_bare <- readRDS('~/TeamTwo/data/traits.rds') %>%
  inner_join(leaf_variables, by = "variable_id") %>%
  select(name, mean, units, description, date, specie_id, site_id, treatment_id)

```

Let's hook leaf_traits up to the species table:

```{r}

# species <- betydb_query(table = "species", limit = 'none') %>%    ## I believe there are 70529 distinct species total; this takes around 10 minutes
#  mutate(specie_id = id)

species <- readRDS('~/TeamTwo/data/species.rds')

leaf_traits <- leaf_traits_bare %>%
  left_join(species, by = "specie_id") %>%
  select(name, mean, units, description, date, specie_id, scientificname, commonname, site_id, treatment_id)

```

Now we're cooking with gas. Some of the species and variables are rather obscure, though (in fact only 21 of the 67 leaf-related variables are populated at all, by my count), so let's see which species have had the most unique variables measured, and which variables have been measured across the widest range of species:

```{r}

traits_ranking <- leaf_traits %>%
  group_by(name) %>%
  mutate(species_with_trait = length(unique(scientificname))) %>%
  select(name, species_with_trait) %>%
  unique

important_traits <- traits_ranking %>%
  filter(species_with_trait >= 20) %>%
  select(name) %>%
  collect()

important_traits = as.vector(important_traits$name)

important_leaf_traits <- leaf_traits %>%
  filter(name %in% important_traits) %>%
  select(scientificname, name, mean)

species_ranking <- important_leaf_traits %>%
  group_by(scientificname) %>%
  mutate(traits_of_species = length(unique(name))) %>%
  select(scientificname, traits_of_species) %>%
  unique

important_species <- species_ranking %>%
  filter(traits_of_species >= 3) %>%
  select(scientificname) %>%
  collect()

important_species = as.vector(important_species$scientificname)

important_leaf_traits = important_leaf_traits %>%
  filter(scientificname %in% important_species)
  
```

It appears there are only 9 leaf variables that have been measured across 10+ species, and only 53 species have had 3+ unique leaf variables measured. Concerning ourselves only with these important species and variables, why not build a program that can predict which species a plant is, given one or more measurements of its leaves?

We will split our data into training data (90%) and testing data (10%) after randomizing it by row.

```{r}

important_leaf_traits = important_leaf_traits[sample(nrow(important_leaf_traits)),]

training = round(nrow(important_leaf_traits)*0.9)
testing = nrow(important_leaf_traits) - training


important_leaf_traits_training <- important_leaf_traits %>%
  head(training) %>%
  group_by(scientificname, name) %>%
  mutate(supermean = mean(mean)) %>%
  mutate(std = sd(mean)) %>%
  select(scientificname, name, supermean, std) %>%
  unique

important_leaf_traits_testing <- important_leaf_traits %>%
  tail(testing)

```

```{r}

organized_important_leaf_traits <- dcast(important_leaf_traits_training, scientificname ~ name, value.var="supermean")
std_analysis <- dcast(important_leaf_traits_training, scientificname ~ name, value.var="std")

important_traits = tail(colnames(organized_important_leaf_traits), -1)

for(i in 1:nrow(organized_important_leaf_traits)){
  for(j in 2:ncol(organized_important_leaf_traits)){
    if(is.na(std_analysis[i,j])){
      organized_important_leaf_traits[i,j] = NA
    }
  }
}

species_distance <- function(species_data, species_std, data_point) {

  incomparables = 0
  n = length(species_data)
  sum_distance = 0
  for(i in 1:length(species_data)){
    if(!is.na(species_data[i]) & !is.na(data_point[i])){
      sum_distance = sum_distance + ((species_data[i]-data_point[i])/species_std[i])^2
    }
    else {
      incomparables = incomparables + 1
    }
  }
  if(incomparables >= n-1){
    return(NA)
  }
  else {
    return(sum_distance / (n - incomparables))
  }
}

predict_species <- function(c2n_leaf = NA, leaf_biomass_area = NA, leaf_biomass_plant = NA, leaf_longevity = NA, leaf_respiration_rate_m2 = NA, leaf_turnover_rate = NA, leafC = NA, leafN = NA, leafP = NA, prediction_key = NA) {
  if(missing(prediction_key)){
    prediction_key = c(c2n_leaf, leaf_biomass_area, leaf_biomass_plant, leaf_longevity, leaf_respiration_rate_m2, leaf_turnover_rate, leafC, leafN, leafP)
  }

  n = nrow(organized_important_leaf_traits)
  m = ncol(organized_important_leaf_traits)
  distance_column = data.frame(matrix(ncol = 1, nrow = n))
  for(i in 1:nrow(organized_important_leaf_traits)){

    distance_column[i,1] = species_distance(organized_important_leaf_traits[i,2:m], std_analysis[i,2:m], prediction_key)

  }
  results_table = organized_important_leaf_traits %>%
    cbind(distance_column)
  results_table = results_table[,c(1,m+1)]
  colnames(results_table) <- c("Species","Difference")

  return(arrange(results_table, results_table[,2]))
}

```

Now that we have our predictor, we can see how well it does on the testing data. We'll do this by first constructing a function which takes a species name and an integer n, and returns how accurate the predictor's guess was given n random leaf measurements from that species (as taken from the testing data).

```{r}

to_key <- function(df, cols) {
  m = length(cols)
  n = nrow(df)
  endDF = data.frame(matrix(nrow = 1, ncol = m))
  colnames(endDF) = cols
  for(col in cols){
    endDF[1,col] = NA
    for(i in 1:n){
      if(df[i,1] == col){
        endDF[1,col] = df[i,2]
      }
    }
  }
  return(endDF)
}

test_predictor <- function(species, traitsN) {

  take_from = important_leaf_traits_testing %>%
    filter(scientificname == species) %>%
    select(name, mean)
  take_from = take_from[sample(nrow(take_from)),]
  take_from = take_from[!duplicated(take_from$name),]
  if(nrow(take_from) < traitsN) {
    return(NA)
  }
  else {
    print(take_from[1:3,])

    return(predict_species(prediction_key = to_key(take_from[1:traitsN,], important_traits)))
  }
}

test_predictor("Betula alleghaniensis",3)


```
